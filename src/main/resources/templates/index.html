<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Peta Interaktif Desa</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- WebSocket dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        #map { height: 85vh; width: 100%; }
        #coords {
            text-align: center;
            background: #f5f5f5;
            padding: 10px;
            border-top: 2px solid #ccc;
            font-weight: bold;
        }
        h2 { text-align: center; margin: 10px; }
    </style>
</head>
<body>

<h2>üó∫Ô∏è Peta Interaktif - Klik untuk Tambah Lokasi</h2>
<div id="map"></div>
<div id="coords">Klik pada peta untuk melihat koordinat</div>

<script>
    // --- Inisialisasi peta ---
    const map = L.map('map').setView([-7.0, 110.0], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // --- Ambil lokasi lama dari server (yang tersimpan di DB) ---
    const lokasiList = /*[[${lokasiList}]]*/ [];
    lokasiList.forEach(l => {
        if (l.latitude && l.longitude) {
            L.marker([l.latitude, l.longitude])
                .addTo(map)
                .bindPopup(`<b>${l.nama}</b><br>${l.deskripsi}`);
        }
    });

    // --- Hubungkan ke WebSocket ---
    const socket = new SockJS('/ws');
    const stompClient = Stomp.over(socket);
    stompClient.connect({}, () => {
        console.log("Terhubung ke WebSocket");

        // Terima lokasi baru dari pengguna lain
        stompClient.subscribe('/topic/locations', (message) => {
            const lokasiBaru = JSON.parse(message.body);
            console.log("Lokasi baru diterima:", lokasiBaru);

            // Tampilkan di peta
            L.marker([lokasiBaru.latitude, lokasiBaru.longitude])
                .addTo(map)
                .bindPopup(`<b>${lokasiBaru.nama}</b><br>${lokasiBaru.deskripsi}`)
                .openPopup();
        });
    });

    // --- Klik peta untuk menambah lokasi ---
    map.on('click', function (e) {
        const lat = e.latlng.lat.toFixed(5);
        const lng = e.latlng.lng.toFixed(5);
        document.getElementById('coords').textContent = `Koordinat: ${lat}, ${lng}`;

        const nama = prompt("Masukkan nama lokasi:");
        const deskripsi = prompt("Masukkan deskripsi singkat:");

        if (!nama || !deskripsi) return;

        const lokasi = {
            nama: nama,
            deskripsi: deskripsi,
            latitude: e.latlng.lat,
            longitude: e.latlng.lng
        };

        // 1Ô∏è‚É£ Simpan ke database via REST API
        fetch('/tambah-lokasi', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(lokasi)
        });

        // 2Ô∏è‚É£ Broadcast ke semua pengguna lewat WebSocket
        stompClient.send("/app/addLocation", {}, JSON.stringify(lokasi));

        // 3Ô∏è‚É£ Tampilkan langsung di peta (pengguna sendiri)
        L.marker([lokasi.latitude, lokasi.longitude])
            .addTo(map)
            .bindPopup(`<b>${nama}</b><br>${deskripsi}`)
            .openPopup();
    });
</script>

</body>
</html>
